<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Healthcare Real-time Analytics Dashboard</title>
    <link
      rel="stylesheet"
      th:href="@{/webjars/bootstrap/5.3.3/css/bootstrap.min.css}"
    />
    <script th:src="@{/webjars/htmx.org/2.0.3/dist/htmx.min.js}"></script>
    <script th:src="@{/webjars/chart.js/4.4.6/dist/chart.umd.js}"></script>
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <div class="row mb-3">
        <div class="col">
          <h1 class="h3">Healthcare Real-time Analytics</h1>
          <p class="text-muted mb-0">
            POC &mdash; Appointment funnel and modality metrics (Kappa-style).
          </p>
        </div>
      </div>

      <div class="row mb-3 align-items-end">
        <div class="col-md-8">
          <div class="card border-0 shadow-sm bg-white">
            <div
              class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between"
            >
              <div class="mb-2 mb-md-0">
                <div class="text-muted small mb-1">Current view</div>
                <div id="currentTenant" class="fw-semibold">
                  Detecting organization and clinic...
                </div>
                <div class="mt-2">
                  <label
                    for="clinicSelector"
                    class="form-label small text-muted mb-1"
                  >
                    Clinic
                  </label>
                  <select
                    id="clinicSelector"
                    class="form-select form-select-sm"
                    disabled
                  >
                    <option>Loading clinics...</option>
                  </select>
                </div>
              </div>
              <div>
                <span id="connectionStatus" class="badge bg-secondary">
                  Disconnected
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mt-3 mt-md-0 text-md-end">
          <button id="reconnectButton" class="btn btn-outline-primary">
            Refresh connection
          </button>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col">
          <ul class="nav nav-pills small" id="viewTabs">
            <li class="nav-item">
              <button class="nav-link active" type="button" data-view="exec">
                Executive summary
              </button>
            </li>
            <li class="nav-item">
              <button class="nav-link" type="button" data-view="detailed">
                Detailed analytics
              </button>
            </li>
          </ul>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title">Scheduled appointments</h6>
              <div id="scheduledCount" class="display-6">0</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title">Completed appointments</h6>
              <div id="completedCount" class="display-6">0</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title">Virtual / In-person</h6>
              <div class="display-6">
                <span id="virtualCount">0</span>/<span id="inPersonCount"
                  >0</span
                >
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h6 class="card-title">Avg. lead/consult (min)</h6>
              <div class="small">Lead: <span id="avgLeadMinutes">0</span></div>
              <div class="small">
                Consult: <span id="avgConsultMinutes">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row d-none" id="chartsRow">
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">Appointment funnel</div>
            <div class="card-body">
              <canvas id="funnelChart" height="160"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-header">Modality mix</div>
            <div class="card-body">
              <canvas id="modalityChart" height="160"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      let eventSource = null;
      let funnelChart = null;
      let modalityChart = null;
      let currentTenant = null;
      let clinicOptions = [];
      let currentView = "exec";

      function initCharts() {
        const funnelCtx = document.getElementById("funnelChart");
        funnelChart = new Chart(funnelCtx, {
          type: "bar",
          data: {
            labels: ["Scheduled", "Completed"],
            datasets: [
              {
                label: "Appointments",
                data: [0, 0],
                backgroundColor: ["#0d6efd", "#20c997"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
          },
        });

        const modalityCtx = document.getElementById("modalityChart");
        modalityChart = new Chart(modalityCtx, {
          type: "doughnut",
          data: {
            labels: ["Virtual", "In-person"],
            datasets: [
              {
                data: [0, 0],
                backgroundColor: ["#6610f2", "#fd7e14"],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "bottom" } },
          },
        });
      }

      function updateConnectionStatus(text, state) {
        const el = document.getElementById("connectionStatus");
        el.textContent = text;
        el.className = "badge";

        if (state === "connected") {
          el.classList.add("bg-success");
        } else if (state === "connecting") {
          el.classList.add("bg-info", "text-dark");
        } else if (state === "error") {
          el.classList.add("bg-danger");
        } else {
          el.classList.add("bg-secondary");
        }
      }

      function formatTenantLabel(tenant) {
        if (!tenant) {
          return "";
        }
        return `${tenant.organizationName} - ${tenant.clinicName}`;
      }

      function connectStreamForTenant(tenant) {
        if (!tenant) {
          return;
        }

        currentTenant = tenant;

        if (eventSource) {
          eventSource.close();
        }

        const url = `/api/analytics/stream?organizationId=${encodeURIComponent(
          tenant.organizationId
        )}&clinicId=${encodeURIComponent(tenant.clinicId)}`;
        eventSource = new EventSource(url);

        updateConnectionStatus("Connecting...", "connecting");

        eventSource.addEventListener("analytics-snapshot", function (event) {
          try {
            const snapshot = JSON.parse(event.data);
            updateDashboard(snapshot);
            updateConnectionStatus("Live", "connected");
          } catch (e) {
            console.error("Failed to parse snapshot", e);
          }
        });

        eventSource.onerror = function () {
          updateConnectionStatus("Disconnected (auto-retry)", "error");
        };
      }

      async function loadDefaultTenantAndConnect() {
        updateConnectionStatus("Detecting clinic...", "connecting");

        try {
          const response = await fetch("/api/tenants/default");
          if (!response.ok) {
            throw new Error("No default tenant available");
          }

          const tenant = await response.json();
          currentTenant = tenant;

          const label = formatTenantLabel(tenant);
          document.getElementById("currentTenant").textContent = label;

          const selector = document.getElementById("clinicSelector");
          if (selector && clinicOptions.length > 0) {
            const match = clinicOptions.find(
              (c) => c.clinicId === tenant.clinicId
            );
            if (match) {
              selector.value = String(match.clinicId);
            }
          }

          connectStreamForTenant(tenant);
        } catch (e) {
          console.error("Failed to load default tenant", e);
          document.getElementById("currentTenant").textContent =
            "No organization/clinic detected yet";
          updateConnectionStatus("Waiting for data...", "error");
        }
      }

      async function loadClinicsDropdown(selectedTenant) {
        try {
          const response = await fetch("/api/tenants/clinics");
          if (!response.ok) {
            return;
          }

          const clinics = await response.json();
          clinicOptions = clinics;

          const selector = document.getElementById("clinicSelector");
          if (!selector) {
            return;
          }

          selector.innerHTML = "";

          if (!clinics || clinics.length === 0) {
            const option = document.createElement("option");
            option.textContent = "No clinics available";
            option.disabled = true;
            option.selected = true;
            selector.appendChild(option);
            selector.disabled = true;
            return;
          }

          clinics.forEach((clinic) => {
            const option = document.createElement("option");
            option.value = String(clinic.clinicId);
            option.textContent = formatTenantLabel(clinic);

            if (selectedTenant && clinic.clinicId === selectedTenant.clinicId) {
              option.selected = true;
            }

            selector.appendChild(option);
          });

          selector.disabled = clinics.length <= 1;
        } catch (e) {
          console.error("Failed to load clinics", e);
        }
      }

      function updateDashboard(snapshot) {
        document.getElementById("scheduledCount").textContent =
          snapshot.scheduledCount ?? 0;
        document.getElementById("completedCount").textContent =
          snapshot.completedCount ?? 0;
        document.getElementById("virtualCount").textContent =
          snapshot.virtualCount ?? 0;
        document.getElementById("inPersonCount").textContent =
          snapshot.inPersonCount ?? 0;

        const leadMinutes = snapshot.averageScheduledToStartSeconds
          ? (snapshot.averageScheduledToStartSeconds / 60).toFixed(1)
          : "0";
        const consultMinutes = snapshot.averageStartToCompleteSeconds
          ? (snapshot.averageStartToCompleteSeconds / 60).toFixed(1)
          : "0";
        document.getElementById("avgLeadMinutes").textContent = leadMinutes;
        document.getElementById("avgConsultMinutes").textContent =
          consultMinutes;

        if (funnelChart) {
          funnelChart.data.datasets[0].data = [
            snapshot.scheduledCount ?? 0,
            snapshot.completedCount ?? 0,
          ];
          funnelChart.update("none");
        }

        if (modalityChart) {
          modalityChart.data.datasets[0].data = [
            snapshot.virtualCount ?? 0,
            snapshot.inPersonCount ?? 0,
          ];
          modalityChart.update("none");
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        initCharts();
        loadClinicsDropdown(null);
        loadDefaultTenantAndConnect();

        document
          .getElementById("reconnectButton")
          .addEventListener("click", function () {
            if (currentTenant) {
              connectStreamForTenant(currentTenant);
            } else {
              loadDefaultTenantAndConnect();
            }
          });

        const selector = document.getElementById("clinicSelector");
        if (selector) {
          selector.addEventListener("change", function () {
            const selectedClinicId = this.value;
            const tenant = clinicOptions.find(
              (c) => String(c.clinicId) === selectedClinicId
            );
            if (tenant) {
              document.getElementById("currentTenant").textContent =
                formatTenantLabel(tenant);
              connectStreamForTenant(tenant);
            }
          });
        }

        const tabs = document.querySelectorAll("#viewTabs .nav-link");
        const chartsRow = document.getElementById("chartsRow");
        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const view = this.getAttribute("data-view");
            if (!view || view === currentView) {
              return;
            }

            currentView = view;

            tabs.forEach((t) => t.classList.remove("active"));
            this.classList.add("active");

            if (!chartsRow) {
              return;
            }

            if (view === "detailed") {
              chartsRow.classList.remove("d-none");
            } else {
              chartsRow.classList.add("d-none");
            }
          });
        });
      });
    </script>
  </body>
</html>
